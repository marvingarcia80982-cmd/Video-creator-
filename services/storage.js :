const AWS = require('aws-sdk');
const { v4: uuidv4 } = require('uuid');

class StorageService {
  constructor() {
    this.s3 = new AWS.S3({
      accessKeyId: process.env.AWS_ACCESS_KEY_ID,
      secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
      region: process.env.AWS_REGION || 'us-east-1'
    });
    this.bucket = process.env.S3_BUCKET_NAME;
  }

  // Upload generated video from URL (AI provider) to S3
  async uploadVideoFromUrl(videoUrl, userId, sceneId) {
    try {
      // Download video from AI provider
      const response = await axios.get(videoUrl, { responseType: 'stream' });
      
      const key = `users/${userId}/scenes/${sceneId}/${uuidv4()}.mp4`;
      
      const uploadParams = {
        Bucket: this.bucket,
        Key: key,
        Body: response.data,
        ContentType: 'video/mp4',
        Metadata: {
          'user-id': userId,
          'scene-id': sceneId,
          'source': 'ai-generated'
        }
      };

      const result = await this.s3.upload(uploadParams).promise();
      
      return {
        url: result.Location,
        key: result.Key,
        bucket: result.Bucket
      };
    } catch (error) {
      console.error('S3 Upload Error:', error);
      throw new Error('Failed to store video');
    }
  }

  // Generate signed URL for download (secure, expires in 1 hour)
  async getSignedDownloadUrl(key, expiresIn = 3600) {
    return this.s3.getSignedUrlPromise('getObject', {
      Bucket: this.bucket,
      Key: key,
      Expires: expiresIn
    });
  }

  // Delete video when user deletes scene
  async deleteVideo(key) {
    return this.s3.deleteObject({
      Bucket: this.bucket,
      Key: key
    }).promise();
  }
}

module.exports = new StorageService();
